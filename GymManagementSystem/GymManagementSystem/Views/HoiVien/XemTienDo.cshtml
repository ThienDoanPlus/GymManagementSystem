<head>
    <link href="@Url.Content("~/Content/Workout/progress.css")" rel="stylesheet" type="text/css" />
</head>
@model GymManagementSystem.Models.HoiVien

@{
    ViewBag.Title = "Bảng Theo Dõi Tiến Độ";
    // Lấy dữ liệu từ ViewBag
    var canNangBatDau = (double)ViewBag.CanNangBatDau;
    var canNangHienTai = (double)ViewBag.CanNangHienTai;
    var thayDoiCanNang = (double)ViewBag.ThayDoiCanNang;
    var soNgayTheoDoi = (int)ViewBag.SoNgayTheoDoi;
}

<div class="progress-dashboard-wrapper">
    <div class="page-header mb-4">
        <h2 class="text-white">@ViewBag.Title</h2>
        <p class="text-muted">Đây là quá trình thay đổi của bạn. Hãy tiếp tục cố gắng!</p>
    </div>

    @if (!Model.ChiSoSucKhoes.Any())
    {
        <div class="alert alert-info">
            <h4>Chưa có dữ liệu!</h4>
            <p>Hiện tại chưa có dữ liệu tiến độ nào được cập nhật. Hãy liên hệ với Huấn luyện viên của bạn để bắt đầu theo dõi ngay nhé.</p>
        </div>
    }
    else
    {
        <!-- Hàng chứa các Card chỉ số KPI -->
        <div class="row g-4 mb-4">
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card start">
                    <h5 class="card-title"><i class="fas fa-flag-checkered card-icon"></i> Cân nặng bắt đầu</h5>
                    <p class="card-value">@canNangBatDau <small>kg</small></p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card current">
                    <h5 class="card-title"><i class="fas fa-weight card-icon"></i> Cân nặng hiện tại</h5>
                    <p class="card-value">@canNangHienTai <small>kg</small></p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card change @(thayDoiCanNang <= 0 ? "negative" : "positive")">
                    <h5 class="card-title"><i class="fas fa-exchange-alt card-icon"></i> Thay đổi</h5>
                    <p class="card-value">@(thayDoiCanNang > 0 ? "+" : "")@thayDoiCanNang <small>kg</small></p>
                </div>
            </div>
            <div class="col-lg-3 col-md-6">
                <div class="kpi-card duration">
                    <h5 class="card-title"><i class="fas fa-calendar-day card-icon"></i> Thời gian theo dõi</h5>
                    <p class="card-value">@soNgayTheoDoi <small>ngày</small></p>
                </div>
            </div>
        </div>

        <!-- Hàng chứa Biểu đồ và Lịch sử -->
        <div class="row g-4">
            <div class="col-lg-8">
                <!-- Biểu đồ -->
                <div class="main-card">
                    <div class="card-header">Biểu đồ Cân nặng theo Thời gian</div>
                    <canvas id="progressChart" height="150"></canvas>
                </div>

                <!-- Lời khuyên AI (đã di chuyển) -->
                @if (Model.ChiSoSucKhoes.Any() && !string.IsNullOrEmpty(Model.ChiSoSucKhoes.Last().LoiKhuyenAI))
                {
                    var loiKhuyenMoiNhat = Model.ChiSoSucKhoes.Last().LoiKhuyenAI;
                    <div class="ai-advice-section">
                        <div class="ai-avatar">
                            <i class="fas fa-robot"></i>
                            <p>Lời khuyên</p>
                        </div>
                        <div class="ai-advice-bubble">
                            <div class="advice-content">
                                @Html.Raw(loiKhuyenMoiNhat.Replace("•", "<br/>•"))
                            </div>
                        </div>
                    </div>
                }
            </div>
            <div class="col-lg-4 d-flex flex-column gap-4">
                <!-- Lịch sử cập nhật -->
                <div class="main-card">
                    <div class="card-header">Lịch sử Cập nhật</div>
                    <ul class="list-group list-group-flush history-list">
                        @foreach (var item in Model.ChiSoSucKhoes.OrderByDescending(cs => cs.NgayCapNhat))
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-calendar-alt text-muted me-2"></i> @item.NgayCapNhat.ToString("dd/MM/yyyy")</span>
                                <span class="badge rounded-pill">@item.CanNang kg</span>
                            </li>
                        }
                    </ul>
                </div>
                <!-- Chỉ số BMI -->
                @if (ViewBag.BMI != null)
                {
                    // Lấy giá trị BMI từ ViewBag
                    var bmiValue = (double)ViewBag.BMI;
                    // Tính toán vị trí của kim chỉ thị trên thanh đo (từ 0% đến 100%)
                    // Giả sử thang đo từ 10 đến 45
                    var markerPosition = ((bmiValue - 10) / (45 - 10)) * 100;
                    if (markerPosition < 0) { markerPosition = 0; }
                    if (markerPosition > 100) { markerPosition = 100; }
                    <div class="main-card">
                        <div class="card-header">Chỉ số BMI Hôm nay</div>
                        <div class="bmi-card-body">
                            <div class="bmi-scale">
                                <!-- Kim chỉ thị -->
                                <div class="bmi-marker" style="left: @markerPosition%;"></div>
                            </div>

                            <div class="bmi-result text-center mt-3">
                                <h3>@bmiValue.ToString("F2") <small>kg/m2</small></h3>
                                <p class="lead">@ViewBag.PhanLoaiBMI</p>
                            </div>

                            <hr />

                            <!-- GHI CHÚ VÀ LỜI KHUYÊN -->
                            <div class="bmi-legend">
                                <h5>Ghi chú:</h5>
                                <ul>
                                    <li><span class="color-box" style="background-color: #00BFFF;"></span>BMI dưới 16: Gầy độ III</li>
                                    <li><span class="color-box" style="background-color: #008B8B;"></span>BMI từ 16 - 18.5: Gầy độ II, I</li>
                                    <li><span class="color-box" style="background-color: #3CB371;"></span>BMI từ 18.5 - 25: Bình thường</li>
                                    <li><span class="color-box" style="background-color: #ADFF2F;"></span>BMI từ 25 - 30: Thừa cân</li>
                                    <li><span class="color-box" style="background-color: #FFA500;"></span>BMI từ 30 - 35: Béo phì độ I</li>
                                    <li><span class="color-box" style="background-color: #FF4500;"></span>BMI từ 35 - 40: Béo phì độ II</li>
                                    <li><span class="color-box" style="background-color: #B22222;"></span>BMI từ 40 trở lên: Béo phì độ III</li>
                                </ul>

                                <h5 class="mt-3">Lời khuyên:</h5>
                                <p class="small text-muted">Dựa vào chỉ số BMI của bạn, hệ thống sẽ đưa ra các lời khuyên phù hợp thông qua Trợ lý ảo bên dưới.</p>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <!-- ====================================================== -->
        <!-- CÁC THÀNH PHẦN CỦA CHATBOT -->
        <!-- ====================================================== -->

        <!-- Nút Chat Nổi -->
        <div id="chat-fab" class="chat-fab">
            <i class="fas fa-comment-dots"></i>
        </div>

        <!-- Khung Chat Popup (mặc định ẩn) -->
        <div id="chat-popup" class="chat-popup">
            <div class="chat-header">
                <h5><i class="fas fa-robot me-2"></i>Trợ lý ảo Fitusion</h5>
                <button id="close-chat-btn" class="close-btn">&times;</button>
            </div>
            <div id="chat-messages" class="chat-messages">
                <div class="chat-message bot">Chào bạn! Tôi có thể giúp gì về sức khỏe của bạn hôm nay?</div>
            </div>
            <div class="chat-input-area">
                <form id="chat-form">
                    <input type="text" id="chat-input" placeholder="Nhập câu hỏi của bạn..." autocomplete="off" />
                    <button type="submit"><i class="fas fa-paper-plane"></i></button>
                </form>
            </div>
        </div>
    }

    @section Scripts {
        @if (Model.ChiSoSucKhoes.Any())
        {
            <script>
            // Đoạn script này hoàn toàn giống với trang của PT
            var labels = [@Html.Raw(String.Join(",", Model.ChiSoSucKhoes.Select(cs => "'" + cs.NgayCapNhat.ToString("dd/MM") + "'")))];
            var data = [@Html.Raw(String.Join(",", Model.ChiSoSucKhoes.Select(cs => cs.CanNang)))];

            const ctx = document.getElementById('progressChart').getContext('2d');
            const progressChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cân nặng (kg)',
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
            </script>
            <script>
        $(document).ready(function () {
            const chatPopup = $('#chat-popup');
            const chatFab = $('#chat-fab');
            const closeChatBtn = $('#close-chat-btn');
            const chatForm = $('#chat-form');
            const chatInput = $('#chat-input');
            const chatMessages = $('#chat-messages');

            // Mở/Đóng khung chat
            chatFab.on('click', () => chatPopup.toggleClass('is-open'));
            closeChatBtn.on('click', () => chatPopup.removeClass('is-open'));

            // Xử lý khi gửi tin nhắn
            chatForm.on('submit', function (e) {
                e.preventDefault();
                const userMessage = chatInput.val().trim();
                if (!userMessage) return;

                // Hiển thị tin nhắn của người dùng
                appendMessage(userMessage, 'user');
                chatInput.val('').focus();

                // Hiển thị trạng thái "đang suy nghĩ" của bot
                const thinkingMessage = appendMessage('', 'bot is-thinking');
                thinkingMessage.html('<span></span><span></span><span></span>'); // Hiệu ứng 3 chấm

                // Lấy AntiForgeryToken từ form trên trang
                const token = $('form[action="/HoiVien/XacNhanThanhToan"] input[name="__RequestVerificationToken"]').val() || $('input[name="__RequestVerificationToken"]').first().val();

                $.ajax({
                    url: '@Url.Action("Ask", "Chatbot")',
                    method: 'POST',
                    data: {
                        __RequestVerificationToken: token,
                        query: userMessage
                    },
                    success: function(response) {
                        // Cập nhật tin nhắn "đang suy nghĩ" bằng câu trả lời thật
                        thinkingMessage.text(response.answer).removeClass('is-thinking');
                    },
                    error: function() {
                        // Xử lý khi có lỗi
                        thinkingMessage.text("Xin lỗi, có lỗi xảy ra. Vui lòng thử lại.").removeClass('is-thinking');
                    },
                    complete: function() {
                         // Luôn cuộn xuống dưới
                        scrollToBottom();
                    }
                });
            });

            // Hàm để thêm tin nhắn vào khung chat
            function appendMessage(text, type) {
                const messageDiv = $('<div></div>').addClass('chat-message ' + type).text(text);
                chatMessages.append(messageDiv);
                scrollToBottom();
                return messageDiv; // Trả về để có thể chỉnh sửa sau (cho tin nhắn "đang suy nghĩ")
            }

            // Hàm để tự động cuộn xuống tin nhắn mới nhất
            function scrollToBottom() {
                chatMessages.scrollTop(chatMessages[0].scrollHeight);
            }
        });
            </script>
        }
    }
