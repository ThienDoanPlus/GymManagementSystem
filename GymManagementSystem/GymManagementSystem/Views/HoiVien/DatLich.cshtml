@{
    ViewBag.Title = "Đặt Lịch & Lịch Trình Tập Luyện";
}

@section Styles {
    <style>
        /* CSS tùy chỉnh cho lịch và form */
        .fc {
            color: #e0e0e0;
        }

            .fc .fc-col-header-cell-cushion, .fc .fc-daygrid-day-number {
                color: #fff;
                text-decoration: none;
            }

            .fc .fc-button-primary {
                background-color: #333;
                border-color: #555;
            }

                .fc .fc-button-primary:hover {
                    background-color: #444;
                }

        .fc-theme-standard .fc-scrollgrid, .fc-theme-standard td, .fc-theme-standard th {
            border-color: #444;
        }

        .time-slot-btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            color: #333;
        }

            .time-slot-btn:hover {
                background-color: #e0e0e0;
            }

            .time-slot-btn.active {
                background-color: #a3ff12;
                color: #000;
                font-weight: bold;
                border-color: #a3ff12;
            }

        .btn-submit-booking {
            background-color: #a3ff12;
            color: #000;
            font-weight: bold;
            border-radius: 50px;
            padding: 12px 24px;
            transition: all 0.2s ease-in-out;
        }

            .btn-submit-booking:hover {
                background-color: #8fde0b;
                color: #000;
            }
    </style>
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0 text-white"><i class="fas fa-calendar-alt me-2"></i> @ViewBag.Title</h2>
    </div>
    <p class="text-muted">Chọn một ngày trống trên lịch để đặt buổi tập, hoặc nhấp vào một buổi tập đã có để xem chi tiết hoặc đánh giá.</p>
    <hr style="border-color: #444;" />
    <div id="calendar"></div>
</div>

@* Modal đánh giá không thay đổi nhiều *@
<div class="modal fade" id="feedbackModal" tabindex="-1">...</div>

@section Scripts {
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var crudOffcanvasEl = document.getElementById('crudOffcanvas');
        var crudOffcanvas = new bootstrap.Offcanvas(crudOffcanvasEl);
        var offcanvasTitle = document.getElementById('offcanvasLabel');
        var offcanvasBody = document.getElementById('offcanvas-body-content');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'vi',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
            events: '@Url.Action("GetLichTapCuaHoiVien", "HoiVien")',
            displayEventTime: true,
            displayEventEnd: false, // Không cần hiển thị giờ kết thúc
            eventDisplay: 'block', // Hiển thị mỗi sự kiện trên một dòng riêng

            eventTimeFormat: { // Định dạng lại giờ cho đẹp
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            },
            eventMouseEnter: function (info) {
                // Sử dụng thư viện tooltip của Bootstrap
                var tooltip = new bootstrap.Tooltip(info.el, {
                    title: info.event.extendedProps.description || info.event.title, // Lấy từ thuộc tính description mới
                    placement: 'top',
                    trigger: 'hover',
                    container: 'body'
                });
                tooltip.show();
            },
            dateClick: function(info) {
                if (info.date < new Date(new Date().setHours(0,0,0,0))) {
                    alert("Không thể đặt lịch cho một ngày trong quá khứ."); return;
                }

                var url = '@Url.Action("GetBookingForm", "HoiVien")' + '?date=' + info.dateStr;

                offcanvasTitle.textContent = 'Đặt Lịch Tập Mới';
                offcanvasBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-light" role="status"></div></div>';
                crudOffcanvas.show();

                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        offcanvasBody.innerHTML = html;
                        $('#offcanvasForm').append(`<div class="d-grid mt-4"><button type="submit" class="btn btn-submit-booking"><i class="fas fa-paper-plane me-2"></i> Gửi Yêu Cầu</button></div>`);
                    });
            },

            eventClick: function(info) { /* ... Giữ nguyên logic cũ ... */ }
        });
        calendar.render();

        function fetchAndDisplaySlots() {
            var ptId = $('#bookingPtId').val();
            var date = $('#bookingDate').val();
            var slotsContainer = $('#availableSlotsContainer');
            var loader = $('#slotsLoader');

            slotsContainer.html('<div class="alert alert-secondary w-100 p-2 text-center">Vui lòng chọn PT và ngày.</div>');
            $('#gioBatDau').val('');

            if (ptId && date) {
                loader.removeClass('d-none');
                $.get('@Url.Action("GetAvailableSlots", "HoiVien")', { ptId: ptId, date: date })
                    .done(function (slots) {
                        slotsContainer.empty();
                        if (slots && slots.length > 0) {
                            slots.forEach(function(slot) {
                                var button = $('<button type="button" class="btn btn-light time-slot-btn"></button>').text(slot);
                                slotsContainer.append(button);
                            });
                        } else {
                            slotsContainer.html('<div class="alert alert-warning w-100 p-2 text-center">Không có lịch trống cho ngày này.</div>');
                        }
                    }).always(function() { loader.addClass('d-none'); });
            }
        }

        $(document).on('change', '#bookingPtId, #bookingDate', fetchAndDisplaySlots);

        $(document).on('click', '.time-slot-btn', function() {
            $('.time-slot-btn').removeClass('active');
            $(this).addClass('active');
            $('#gioBatDau').val($(this).text());
        });

        $(document).on('submit', '#offcanvasForm', function(e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr('action'),
                method: form.attr('method'),
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        crudOffcanvas.hide();
                        calendar.refetchEvents();
                        alert(response.message);
                    } else { alert('Lỗi: ' + response.message); }
                },
                error: function() { alert("Đã có lỗi kết nối khi gửi yêu cầu."); }
            });
        });
    });
    </script>
}