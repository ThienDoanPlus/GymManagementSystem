<link href="@Url.Content("~/Content/Calender/custom.css")" rel="stylesheet" type="text/css" />

@{
    ViewBag.Title = "Đặt Lịch & Lịch Trình Tập Luyện";
}
@* Bỏ section Styles vì đã chuyển CSS vào file chung/riêng *@

<div class="container mt-4">
    <div class="page-header mb-4">
        <h2 class="text-white"><i class="fas fa-calendar-alt me-2"></i> @ViewBag.Title</h2>
        <p class="text-muted">Chọn một ngày trống trên lịch để đặt buổi tập, hoặc nhấp vào một buổi tập đã có để xem chi tiết.</p>
    </div>

    <!-- Bọc lịch trong một container mới -->
    <div class="calendar-wrapper">
        <div id="calendar"></div>
    </div>
</div>

@* Modal và Offcanvas giữ nguyên cấu trúc HTML, chúng sẽ tự động được style bởi CSS mới *@

@section Scripts {
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');
        var crudOffcanvasEl = document.getElementById('crudOffcanvas');
        var crudOffcanvas = new bootstrap.Offcanvas(crudOffcanvasEl);
        var offcanvasTitle = document.getElementById('offcanvasLabel');
        var offcanvasBody = document.getElementById('offcanvas-body-content');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'vi',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
            events: '@Url.Action("GetLichTapCuaHoiVien", "HoiVien")',
            displayEventTime: true,
            displayEventEnd: false,
            eventDisplay: 'block',
            eventTimeFormat: { hour: '2-digit', minute: '2-digit', hour12: false },

            eventMouseEnter: function (info) {
                // (Optional) Có thể tùy chỉnh lại tooltip sau
            },

            dateClick: function(info) {
                if (info.date < new Date(new Date().setHours(0,0,0,0))) {
                    alert("Không thể đặt lịch cho một ngày trong quá khứ."); return;
                }

                var url = '@Url.Action("GetBookingForm", "HoiVien")' + '?date=' + info.dateStr;

                offcanvasTitle.textContent = 'Đặt Lịch Tập Mới';
                offcanvasBody.innerHTML = '<div class="text-center p-5"><div class="spinner-border text-light" role="status"></div></div>';
                crudOffcanvas.show();

                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        offcanvasBody.innerHTML = html;
                        // Gắn nút submit đã được style vào form
                        $('#offcanvasForm').append(`<div class="offcanvas-footer"><button type="submit" class="btn-submit-booking"><i class="fas fa-paper-plane me-2"></i> Gửi Yêu Cầu</button></div>`);
                    });
            },

            eventClick: function(info) {
                // Logic eventClick của bạn giữ nguyên
            }
        });
        calendar.render();

        // --- JavaScript cho form trong Offcanvas (giữ nguyên logic, chỉ thay đổi CSS) ---
        function fetchAndDisplaySlots() {
            var ptId = $('#bookingPtId').val();
            var date = $('#bookingDate').val();
            var slotsContainer = $('#availableSlotsContainer');
            var loader = $('#slotsLoader');

            slotsContainer.html('<div class="alert alert-secondary w-100 p-2 text-center" style="background-color: #2b2b2b; border-color: #444; color: #ccc;">Vui lòng chọn PT và ngày.</div>');
            $('#gioBatDau').val('');

            if (ptId && date) {
                loader.removeClass('d-none');
                $.get('@Url.Action("GetAvailableSlots", "HoiVien")', { ptId: ptId, date: date })
                    .done(function (slots) {
                        slotsContainer.empty();
                        if (slots && slots.length > 0) {
                            slots.forEach(function(slot) {
                                var button = $('<button type="button" class="time-slot-btn"></button>').text(slot);
                                slotsContainer.append(button);
                            });
                        } else {
                            slotsContainer.html('<div class="alert alert-warning w-100 p-2 text-center" style="background-color: rgba(251, 146, 60, 0.15); border-color: rgba(251, 146, 60, 0.3); color: #fb923c;">Không có lịch trống cho ngày này.</div>');
                        }
                    }).always(function() { loader.addClass('d-none'); });
            }
        }

        $(document).on('change', '#bookingPtId, #bookingDate', fetchAndDisplaySlots);
        $(document).on('click', '.time-slot-btn', function() {
            $('.time-slot-btn').removeClass('active');
            $(this).addClass('active');
            $('#gioBatDau').val($(this).text());
        });
        $(document).on('submit', '#offcanvasForm', function(e) {
            e.preventDefault();
            var form = $(this);
            $.ajax({
                url: form.attr('action'),
                method: form.attr('method'),
                data: form.serialize(),
                success: function(response) {
                    if (response.success) {
                        crudOffcanvas.hide();
                        calendar.refetchEvents();
                        // (Tùy chọn) Thay alert bằng một thông báo đẹp hơn
                        alert(response.message);
                    } else { alert('Lỗi: ' + response.message); }
                },
                error: function() { alert("Đã có lỗi kết nối khi gửi yêu cầu."); }
            });
        });
    });
    </script>
    }