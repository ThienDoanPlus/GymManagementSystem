@model GymManagementSystem.Models.KeHoach
@{
    // Lấy lại ViewModel từ trang cha để truy cập các Dictionary
    var parentModel = (GymManagementSystem.Models.ViewModels.KeHoachListViewModel)ViewData["ParentModel"];
    bool isRegistered = parentModel.DangKyIds.ContainsKey(Model.Id);
}

@{
    string illustrationUrl = "https://images.unsplash.com/photo-1576678927484-cc907957088c?q=80&w=1974&auto=format&fit=crop";
    if (Model.TenKeHoach.ToLower().Contains("yoga")) { illustrationUrl = "https://images.unsplash.com/photo-1544367567-0f2fcb009e0b?q=80&w=2120&auto=format&fit=crop"; }
    else if (Model.TenKeHoach.ToLower().Contains("cycling")) { illustrationUrl = "https://images.unsplash.com/photo-1576678927484-cc907957088c?q=80&w=1974&auto=format&fit=crop"; }
    else if (Model.TenKeHoach.ToLower().Contains("running")) { illustrationUrl = "https://images.unsplash.com/photo-1475113548554-5a36f1f523d6?q=80&w=2070&auto=format&fit=crop"; }
}

<div class="plan-card">
    @if (isRegistered)
    {
        var progress = parentModel.TienDoKeHoach.ContainsKey(Model.Id) ? parentModel.TienDoKeHoach[Model.Id] : 0;
        <div class="progress-circle mt-5" style="--p:@progress;">
            @progress%
        </div>
    }

    <img src="@illustrationUrl" alt="@Model.TenKeHoach" class="illustration" />

    <div class="plan-card-content">
        <h3>@Model.TenKeHoach</h3>
        <p class="duration">@Model.ThoiGianThucHien ngày</p>

        @if (isRegistered)
        {
            var dangKyId = parentModel.DangKyIds[Model.Id];
            // SỬA LỖI Ở ĐÂY: Tên tham số là "dangKyKeHoachId"
            @Html.ActionLink("Xem tiến độ", "XemKeHoach", "ThucHienKeHoach", new { dangKyKeHoachId = dangKyId }, new { @class = "btn-start" })
        }
        else
        {
            using (Html.BeginForm("DangKy", "KeHoach", new { keHoachId = Model.Id }, FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <button type="submit" class="btn-start">Bắt đầu ngay</button>
            }
        }
    </div>
</div>