@model GymManagementSystem.Models.PTDashboardViewModel
@{
    ViewBag.Title = "Bảng Điều Khiển Huấn Luyện Viên";
}

<h2><i class="fas fa-tachometer-alt"></i> @ViewBag.Title</h2>
<hr />

<div class="row">
    <!-- Cột Lịch hẹn sắp tới -->
    <div class="col-md-6">
        <h3><i class="fas fa-calendar-check"></i> Lịch hẹn sắp tới</h3>
        <div id="lich-sap-toi-container">
            @if (!Model.LichSapToi.Any())
            {
                <p class="text-muted">Bạn không có lịch hẹn nào sắp tới.</p>
            }
            else
            {
                <ul class="list-group">
                    @foreach (var item in Model.LichSapToi)
                    {
                        <li class="list-group-item list-group-item-success">
                            <div><strong>Hội viên:</strong> @item.HoiVien.ApplicationUser.HoTen</div>
                            <div><strong>Thời gian:</strong> <span class="font-weight-bold">@item.ThoiGianBatDau.ToString("dd/MM/yyyy HH:mm")</span></div>
                            <div class="mt-2">
                                <a href="#" class="btn btn-sm btn-info"><i class="fas fa-chart-line"></i> Xem tiến độ</a>
                                @* Nút hủy sẽ cần một modal để nhập lý do *@
                                <button type="button" class="btn btn-sm btn-outline-danger" data-toggle="modal" data-target="#cancelModal" data-lichtapid="@item.Id">
                                    <i class="fas fa-times"></i> Hủy
                                </button>
                            </div>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>

    <!-- Cột Yêu cầu đặt lịch mới -->
    <div class="col-md-6">
        <h3><i class="fas fa-bell"></i> Yêu cầu đặt lịch mới</h3>
        <div id="yeu-cau-moi-container">
            @if (!Model.LichChoDuyet.Any())
            {
                <p class="text-muted">Không có yêu cầu mới nào.</p>
            }
            else
            {
                <ul class="list-group">
                    @foreach (var item in Model.LichChoDuyet)
                    {
                        <li class="list-group-item list-group-item-warning">
                            <div><strong>Hội viên:</strong> @item.HoiVien.ApplicationUser.HoTen</div>
                            <div><strong>Thời gian:</strong> @item.ThoiGianBatDau.ToString("dd/MM/yyyy HH:mm")</div>
                            <div class="mt-2">
                                @using (Html.BeginForm("DuyetLich", "PT", new { lichTapId = item.Id }, FormMethod.Post, new { @style = "display:inline-block; margin-right:5px;" }))
                                {
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-success"><i class="fas fa-check"></i> Duyệt</button>
                                }
                                <button type="button" class="btn btn-sm btn-danger" data-toggle="modal" data-target="#cancelModal" data-lichtapid="@item.Id">
                                    <i class="fas fa-times"></i> Từ chối
                                </button>
                            </div>
                        </li>
                    }
                </ul>
            }
        </div>
    </div>
</div>

<!-- Modal để Hủy/Từ chối lịch -->
<div class="modal fade" id="cancelModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            @using (Html.BeginForm("HuyLich", "PT", FormMethod.Post))
            {
                @Html.AntiForgeryToken()
                <div class="modal-header">
                    <h5 class="modal-title">Xác nhận Hủy/Từ chối Lịch hẹn</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Vui lòng nhập lý do hủy hoặc từ chối lịch hẹn này.</p>
                    <input type="hidden" id="cancelLichTapId" name="lichTapId" />
                    <div class="form-group">
                        <label for="lyDo">Lý do:</label>
                        <textarea id="lyDo" name="lyDo" class="form-control" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-danger">Xác nhận</button>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Script để truyền lichTapId vào modal khi nhấn nút Hủy
        $('#cancelModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // Nút đã được click
            var lichTapId = button.data('lichtapid'); // Lấy dữ liệu từ thuộc tính data-lichtapid
            var modal = $(this);
            modal.find('#cancelLichTapId').val(lichTapId);
        });
    </script>
}