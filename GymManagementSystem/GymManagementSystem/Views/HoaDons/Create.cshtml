@model GymManagementSystem.Models.ViewModels.TaoHoaDonViewModel

@{
    // Nếu là Partial View, không cần Layout
    if (!Request.IsAjaxRequest())
    {
        Layout = "~/Views/Shared/_Layout.cshtml";
    }
}

<!-- Tiêu đề này sẽ được file app-crud.js lấy làm tiêu đề cho Offcanvas -->
<h2>Lập Hóa Đơn Mới</h2>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })

    <div class="mb-3">
        @Html.LabelFor(m => m.HoiVienId, "Chọn Hội Viên", new { @class = "form-label" })
        @Html.DropDownListFor(m => m.HoiVienId, Model.DanhSachHoiVien, "-- Chọn hội viên --", new { @class = "form-select", id = "hoiVienSelect" })
    </div>

    <div class="mb-3">
        @Html.LabelFor(m => m.GoiTapId, "Chọn Gói Tập", new { @class = "form-label" })
        @Html.DropDownListFor(m => m.GoiTapId, Model.DanhSachGoiTap, "-- Chọn gói tập --", new { @class = "form-select", id = "goiTapSelect" })
    </div>

    <div class="mb-3">
        @Html.LabelFor(m => m.KhuyenMaiId, "Áp dụng Khuyến Mãi (Nếu có)", new { @class = "form-label" })
        @Html.DropDownListFor(m => m.KhuyenMaiId, Model.DanhSachKhuyenMai, new { @class = "form-select", id = "khuyenMaiSelect", disabled = "disabled" })
    </div>

    <hr class="my-4" />
    <h5 class="mb-3">Chi tiết thanh toán</h5>
    <ul class="list-group list-group-flush">
        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent text-white px-0">
            Giá gốc
            <span id="giaGocDisplay">0 VNĐ</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent text-white px-0">
            Giảm giá
            <span class="text-danger" id="giamGiaDisplay">0 VNĐ</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent text-white px-0 border-top pt-3">
            <strong>Thành tiền</strong>
            <strong id="thanhTienDisplay" style="font-size: 1.2rem; color: #a5ff36;">0 VNĐ</strong>
        </li>
    </ul>
    <hr class="my-4" />

    <div class="offcanvas-footer">
        <div class="d-grid gap-2">
            <input type="submit" value="Tạo Hóa đơn" class="btn btn-offcanvas-primary" />
        </div>
    </div>
}


<!--
    Quan trọng: Đoạn script này phải được đặt trực tiếp trong file partial view.
    Khi jQuery tải HTML này vào Offcanvas, nó sẽ tự động thực thi đoạn script này,
    gắn các sự kiện 'change' vào các dropdown và làm cho chức năng tính giá hoạt động.
-->
<script>
    // Đảm bảo script chỉ chạy sau khi DOM đã sẵn sàng
    $(document).ready(function() {
        // --- KHAI BÁO BIẾN ---
        const hoiVienSelect = $('#hoiVienSelect');
        const goiTapSelect = $('#goiTapSelect');
        const khuyenMaiSelect = $('#khuyenMaiSelect');
        let giaGoc = 0;
        let soTienGiam = 0;

        // --- CÁC HÀM ---
        function updatePrice() {
            var thanhTien = giaGoc - soTienGiam;
            if (thanhTien < 0) thanhTien = 0;
            var format = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });
            $('#giaGocDisplay').text(format.format(giaGoc));
            $('#giamGiaDisplay').text(format.format(soTienGiam));
            $('#thanhTienDisplay').text(format.format(thanhTien));
        }

        function loadKhuyenMai() {
            const hoiVienId = hoiVienSelect.val();
            const goiTapId = goiTapSelect.val();

            if (hoiVienId && goiTapId) {
                khuyenMaiSelect.prop('disabled', true).html('<option value="">Đang tải...</option>');
                $.getJSON('@Url.Action("GetAvailableVouchers", "HoaDons")', { hoiVienId: hoiVienId, goiTapId: goiTapId }, function (vouchers) {
                    khuyenMaiSelect.empty();
                    khuyenMaiSelect.append($('<option>', { value: '', text: '-- Không áp dụng --' }));
                    if (vouchers && vouchers.length > 0) {
                        $.each(vouchers, function (i, voucher) {
                            khuyenMaiSelect.append($('<option>', { value: voucher.Value, text: voucher.Text }));
                        });
                        khuyenMaiSelect.prop('disabled', false);
                    } else {
                        khuyenMaiSelect.html('<option value="">Không có KM hợp lệ</option>');
                    }
                    // Trigger change để tính lại tiền giảm giá (trường hợp không áp dụng)
                    khuyenMaiSelect.trigger('change');
                });
            } else {
                khuyenMaiSelect.prop('disabled', true).html('<option value="">-- Chọn Hội viên và Gói tập --</option>');
                // Trigger change để reset tiền giảm giá
                khuyenMaiSelect.trigger('change');
            }
        }

        // --- GẮN SỰ KIỆN ---
        hoiVienSelect.on('change', loadKhuyenMai);

        goiTapSelect.on('change', function () {
            var goiTapId = $(this).val();
            if (goiTapId) {
                $.get('@Url.Action("GetGoiTapInfo", "HoaDons")', { id: goiTapId }, function (data) {
                    giaGoc = data ? data.giaGoc : 0;
                    loadKhuyenMai(); // Tải lại danh sách KM sau khi có giá mới
                    updatePrice();   // Cập nhật giá gốc ngay lập tức
                });
            } else {
                giaGoc = 0;
                loadKhuyenMai();
                updatePrice();
            }
        });

        khuyenMaiSelect.on('change', function () {
            var khuyenMaiId = $(this).val();
            if (khuyenMaiId && giaGoc > 0) {
                $.get('@Url.Action("GetKhuyenMaiDiscount", "HoaDons")', { id: khuyenMaiId, giaGoc: giaGoc }, function (data) {
                    soTienGiam = data ? data.soTienGiam : 0;
                    updatePrice();
                });
            } else {
                soTienGiam = 0;
                updatePrice();
            }
        });
    });
</script>